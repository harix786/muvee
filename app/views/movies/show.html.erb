<%= render 'subnav' %>
<div class="inline-movie-preview">
  <div class="featured-image js-auto-slideshow">
    <% @movie.fanarts.shuffle.each do |art| %>
      <div class="movie-background hidden" data-background-url="<%= art.url %>"></div>
    <% end %>
  </div>
</div>

<div id="movie_show">

  <div class="movie-information">
    <div class="movie-information-meta">

      <h3 class="video-type">Movie</h3>
      <% if @movie.downloading? %>
        <h3 class='video-status'>Downloading Now</h3>
      <% end %>
      <h1 class="movie-title">
        <span class="title"><%= @movie.title %></span>
        <span class="three-d <% unless @movie.is_3d? %>hide<% end %>">3D</span>
      </h1>

      <h3 class="year">
        <i class="fa fa-calendar"></i>
        <%= @movie.year %>

        <% if @movie.downloading? %>
          <i class="fa fa-clock-o"></i>
          <%= human_duration(@movie.duration || (@movie.runtime_minutes * 60)) %>
        <% end %>
      </h3>

      <% if @movie.quality.present? %>
        <span class="badge quality-<%= @movie.quality %>"><%= @movie.quality %></span>
      <% end %>
      <%= render 'genre_badge_listing', genres: @movie.genres %>

      <p class="movie-rating">
        <%= render 'shared/star_rating', rating: @movie.vote_average || 0, rating_max: 10.0, new_scale: 5 %>
        <% if @movie.vote_count.present? %>
          from <%= @movie.vote_count %> votes
        <% end %>
      </p>
      <p>
        <%= @movie.overview %>
      </p>

      <img class="movie-poster" src="<%= @movie.poster_url %>">

      <p>
        <%= link_to imdb_link(@movie.imdb_id), target: :_blank do %>
          <%= render 'shared/imdb_logo' %>
        <% end %>
        <%= render 'shared/tmdb_logo' %>
      </p>
    </div>


    <div class="movie-actions">
      <div class="movie-actions-contents">
        <% if @movie.local? %>
          <a
            class="js-get-thumbnails js-has-thumbnails video-thumbnail <% if @movie.has_set_of_thumbnails? %>has-thumbnails<% end %>"
            data-thumbnail-path="<%= thumbnails_video_path(@movie) %>"
            href="<%= video_path(@movie) %>" class="video-link">
            <div class="thumbnail-area">
              <div class="thumbnails">
                <% @movie.thumbnails.each_with_index do |thumb, i| %>
                  <img class="video-thumbnail <% if i>0 %>hidden<% end %>" src="<%= thumb.url %>" alt="">
                <% end %>
              </div>
              <div class="play-icon">
                <i class="fa fa-play-circle"></i>
              </div>
              <div class="duration">
                <i class="fa fa-clock-o"></i>
                <%= human_duration(@movie.duration || (@movie.runtime_minutes * 60)) %>
              </div>
              <% if @movie.left_off_at_percent > 0 %>
                <div class="watch-progress progress-bar__container">
                  <span class="progress-bar__bar" title="<%= @movie.left_off_at %> seconds of <%= @movie.duration %> total seconds" style="width: <%= @movie.left_off_at_percent %>%"></span>
                </div>
              <% end %>
            </div>
          </a>
          <div class="inline-buttons">
            <% if @movie.left_off_at_percent > 5 %>
              <%= link_to "Resume", video_path(@movie), class: 'action-button' %>
              <%= link_to "Play from the start", video_path(@movie, t: 0), class: 'action-button' %>
            <% else %>
              <%= link_to "Play", video_path(@movie, t: 0), class: 'action-button' %>
            <% end %>
            <%= link_to "Re-analyze", reanalyze_movie_path(@movie), class: 'action-button', "tg-remote" => "POST" %>

            <% unless @movie.remote? %>
              <div class="action-button" data-modal="destroy-movie">Delete</div>

              <div id="destroy-movie" class="modal">
                <div class="modal-backdrop js-close-modal"></div>
                <div class="modal-box">
                  <div class="modal-box-contents">
                    <div class="modal-header">
                      Are you sure you want to delete this movie?
                    </div>
                    <div class="divider">
                      <%= button_to 'Yes', movie_path(@movie), method: 'delete' %>
                    </div>
                    <div class="divider">
                      <button class="js-close-modal">
                        Nope
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <%= form_for @movie, url: override_imdb_id_movie_path(@movie), html: {'tg-remote' => true} do |f| %>
                <%= f.text_field :imdb_id %>
                <%= f.submit "Override IMDB ID" %>
              <% end %>

              <p>
                <%= @movie.raw_file_path %>
              </p>
            <% end %>
          </div>
        <% elsif @movie.remote? %>
          <h2>Download this movie</h2>
          <% if @existing_copies.length > 0 %>
            <p>
              You already have this movie in:
            </p>
            <ul>
              <% @existing_copies.each do |copy| %>
                <li>
                  <%= link_to movie_path(copy) do %>
                    <% if copy.is_3d? %>3D<% end %> <%= copy.quality %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          <% end %>
          <div id="yts-sources" refresh="yts-sources">
            <%= link_to "Search YTS", find_sources_via_yts_movie_path(@movie, q: @movie.title), "tg-remote" => "GET", "refresh-on-success" => "yts-sources", class: "yts-logo tracker-logo" %>
          </div>
          <div id="tbp-sources" refresh="tbp-sources">
            <%= link_to "Search the Pirate Bay", find_sources_via_pirate_bay_movie_path(@movie, q: @movie.title), "tg-remote" => "GET", "refresh-on-success" => "tbp-sources", class: "tbp-logo tracker-logo" %>
          </div>
        <% end %>
      </div>
    </div>

    <% if @movie.downloading? %>
      <div id="torrent-progress-<%= @movie.id %>" class="torrent-progress progress-bar__container">
        <div class="progress-bar__bar"></div>
      </div>
    <% end %>

  </div>
</div>
