<%= render 'subnav' %>

<div class="showpage-container" id="series-show" refresh='series-show'>

  <div class="showpage-header">
    <%= render 'shared/showpage_slideshow', urls: @series.backdrop_images.present? ? @series.backdrop_images.shuffle.map(&:url) : [] %>

    <div class="showpage-header__overlay">
      <div class="showpage-header__overlay__top-scrim">
        <%= render 'shared/genre_badge_listing', genres: @series.genres, paginator_path: self.method(:by_genre_series_index_path) %>
        <div class="fr">
          <%= link_to @series.is_favorite ? unfavorite_series_path(@series) : favorite_series_path(@series),
                id: 'fav-button',
                class: 'badge linked-badge',
                data: {
                  tg_remote: 'POST',
                  refresh: 'fav-button',
                  refresh_on_success: 'fav-button',
                  tg_remote_nopushstate: ''
                } do %>
            <i class="fa <% if @series.is_favorite %>fa-heart<% else %>fa-heart-o<% end %>"></i>
          <% end %>

          <%= link_to reanalyze_series_path(@series),
                class: 'badge linked-badge',
                data: {
                  tg_remote: 'POST',
                  refresh_on_success: 'series-show',
                  tg_remote_nopushstate: ''
                } do %>
            <i class="fa fa-refresh"></i>
          <% end %>
        </div>
      </div>

      <% if @series.has_local_episodes %>
        <div class="play-icon">
          <%= link_to shuffle_series_path(@series), class: 'play-icon-link' do %>
            <i class="fa fa-random"></i>
          <% end %>
        </div>
      <% end %>

      <div class="showpage-header__overlay__bottom-scrim flex flex-down">
        <div class="flex">
          <div class="showpage__section flex">
            <img class="showpage__poster" src="<%= @series.poster_url %>">
            <div class="showpage__meta">
              <h1><%= @series.title %></h1>
              <p class="st">
                <%= @series.overview %>
              </p>
              <div class="flex-columns sst">
                <div>
                  <%= render 'shared/star_rating', vote_count: @series.tmdb_vote_count, rating: @series.tmdb_vote_average || 0, rating_max: 10.0, new_scale: 5 %>
                </div>
                <% if @series.first_air_date.present? %>
                  <div>
                    <i class="subdued fa fa-calendar"></i>
                    <%= released_on_human(@series.first_air_date) %>

                    <% if @series.ended && @series.last_air_date.present? %>
                      &mdash; <%= released_on_human(@series.last_air_date) %>
                    <% end %>
                  </div>
                <% end %>
                <%= link_to imdb_link(@series.imdb_id), class: 'metadata-service-logo-link', target: :_blank do %>
                  <%= render 'shared/imdb_logo' %>
                <% end %>
                <%= link_to tmdb_series_link(@series.tmdb_id), class: 'metadata-service-logo-link', target: :_blank do %>
                  <%= image_tag 'tmdb-logo' %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <% if @all_episodes.any? %>
    <div class="flex" id='episode-listing-toggle' refresh='episode-listing'>
      <div class="showpage__section">
        <div class="badges">
          <div class="badge-listing">
            <%= link_to "Latest", series_path(@series, season: @season, sort: :latest),
                  class: "badge linked-badge #{'active' if @sort == :latest}",
                  data: {
                    tg_remote: "GET",
                    tg_remote_nopushstate: '',
                    refresh_on_success: 'episode-listing'
                  }  %>
            <%= link_to "Unwatched", series_path(@series, season: @season, sort: :unwatched),
                  class: "badge linked-badge #{'active' if @sort == :unwatched}",
                  data: {
                    tg_remote: "GET",
                    tg_remote_nopushstate: '',
                    refresh_on_success: 'episode-listing'
                  } %>
            <%= link_to "In order", series_path(@series, season: @season, sort: :release_order),
                  class: "badge linked-badge #{'active' if @sort == :release_order}",
                  data: {
                    tg_remote: "GET",
                    tg_remote_nopushstate: '',
                    refresh_on_success: 'episode-listing'
                  } %>
          </div>
          <div class="badge-listing">
            <%= link_to "All", series_path(@series, season: 'all', sort: @sort),
                  class: "badge #{'active' if @season.blank?}",
                  data: {
                    tg_remote: "GET",
                    tg_remote_nopushstate: '',
                    refresh_on_success: 'episode-listing'
                  }  %>
            <% @seasons.each do |s| %>
              <%= link_to "S#{s}", series_path(@series, season: s, sort: @sort),
                  class: "badge linked-badge #{'active' if @season == s}",
                  data: {
                    tg_remote: "GET",
                    tg_remote_nopushstate: '',
                    refresh_on_success: 'episode-listing'
                  } %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="flex" id='episode-listing' refresh='episode-listing'>
      <div class="showpage__section">
        <%
          grouped_by_season = @videos.group_by{|v| v.season}
        %>
        <% grouped_by_season.keys.each do |season| %>
          <div class="series-season">
            <h3>Season <%= season %></h3>

            <% grouped_by_season[season].each do |video| %>
              <%= render 'episode', video: video, detailed: false %>
            <% end %>
          </div>

        <% end %>

        <% if @videos.size == 0 && @sort == :unwatched %>
          <h2>It looks like you've seen everything!</h2>
        <% end %>
      </div>
    </div>
  <% end %>

  <%= render 'shared/showpage_people', header: 'Actors', roles: @series.cast %>

</div>
